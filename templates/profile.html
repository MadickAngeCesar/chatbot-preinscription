<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mon Profil - ICT University</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .profile-container {
        max-width: 100%;
        margin: 0;
        padding: 40px;
        background: transparent;
        min-height: 100vh;
      }

      .profile-header {
        background: white;
        color: #1f2937;
        padding: 48px;
        border-radius: 16px;
        margin-bottom: 32px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
      }

      .profile-header-content {
        display: flex;
        align-items: center;
        gap: 32px;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .profile-info h1 {
        font-size: 28px;
        margin-bottom: 8px;
        font-weight: 600;
        color: #1f2937;
      }

      .profile-info p {
        font-size: 14px;
        color: #6b7280;
        margin: 6px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .profile-info p i {
        color: #9ca3af;
        font-size: 13px;
      }

      .profile-badge {
        display: inline-block;
        padding: 6px 16px;
        background: #f3f4f6;
        border-radius: 20px;
        font-size: 13px;
        margin-top: 12px;
        color: #4b5563;
        font-weight: 500;
      }

      .profile-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
      }

      .profile-card {
        background: white;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }

      .profile-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .profile-card h2 {
        font-size: 18px;
        color: #1f2937;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
      }

      .profile-card h2 i {
        color: #667eea;
        font-size: 20px;
      }

      .form-group {
        margin-bottom: 24px;
      }

      .form-group label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s ease;
        background: #ffffff;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group input:disabled {
        background: #f9fafb;
        cursor: not-allowed;
        color: #9ca3af;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5558dd;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #4b5563;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        margin-top: 24px;
      }

      .stat-card {
        background: #f9fafb;
        color: #1f2937;
        padding: 24px;
        border-radius: 12px;
        text-align: center;
        border: 1px solid #e5e7eb;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #667eea;
      }

      .stat-label {
        font-size: 13px;
        color: #6b7280;
        font-weight: 500;
      }

      .preinscriptions-list {
        max-height: 500px;
        overflow-y: auto;
      }

      .preinscriptions-list::-webkit-scrollbar {
        width: 6px;
      }

      .preinscriptions-list::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      .preinscription-item {
        padding: 20px;
        border-left: 3px solid #667eea;
        background: #f9fafb;
        margin-bottom: 12px;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .preinscription-item:hover {
        background: #f3f4f6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .preinscription-item h3 {
        font-size: 15px;
        color: #1f2937;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .preinscription-item p {
        font-size: 13px;
        color: #6b7280;
        margin: 4px 0;
      }

      .status-badge {
        display: inline-block;
        padding: 5px 14px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-nouveau {
        background: #dbeafe;
        color: #1e40af;
      }

      .status-en_cours {
        background: #fef3c7;
        color: #92400e;
      }

      .status-validé {
        background: #d1fae5;
        color: #065f46;
      }

      .status-rejeté {
        background: #fee2e2;
        color: #991b1b;
      }

      .alert {
        padding: 16px 20px;
        border-radius: 8px;
        margin-bottom: 24px;
        display: none;
        font-size: 14px;
      }

      .alert-success {
        background: #d1fae5;
        border-left: 3px solid #10b981;
        color: #065f46;
      }

      .alert-error {
        background: #fee2e2;
        border-left: 3px solid #ef4444;
        color: #991b1b;
      }

      @media (max-width: 768px) {
        .profile-container {
          padding: 20px;
        }

        .profile-header {
          padding: 32px 24px;
        }

        .profile-header-content {
          flex-direction: column;
          text-align: center;
        }

        .profile-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .profile-card {
          padding: 24px;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-container">
      <!-- SIDEBAR GAUCHE -->
      <aside class="sidebar-left">
        <div class="sidebar-header">
          <div class="university-logo">
            <img
              src="{{ url_for('static', filename='img/logo.svg') }}"
              alt="ICT University"
              onerror="this.style.display='none'; this.parentNode.querySelector('.fallback-icon').style.display='flex'"
            />
            <i
              class="fas fa-graduation-cap fallback-icon"
              aria-hidden="true"
              style="display: none"
            ></i>
          </div>
          <h1 class="university-name">ICT University</h1>
        </div>

        <nav class="nav-menu">
          <a href="{{ url_for('chat') }}" class="nav-item">
            <i class="fas fa-comments"></i>
            <span>Conversation</span>
          </a>
          <a href="{{ url_for('preinscription') }}" class="nav-item">
            <i class="fas fa-file-alt"></i>
            <span>Préinscription</span>
          </a>
          <a href="{{ url_for('profile') }}" class="nav-item active">
            <i class="fas fa-user"></i>
            <span>Mon Profil</span>
          </a>
          <!-- Home link removed per design -->
        </nav>

        <div class="sidebar-footer">
          <a href="#" class="nav-item logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Déconnexion</span>
          </a>
        </div>
      </aside>

      <!-- CONTENU PRINCIPAL -->
      <main class="main-content">
        <div class="profile-container">
          <!-- Profile Header -->
          <div class="profile-header">
            <div class="profile-header-content">
              <div class="profile-avatar" id="avatar">
                <i class="fas fa-user"></i>
              </div>
              <div class="profile-info">
                <h1 id="userName">Chargement...</h1>
                <p>
                  <i class="fas fa-envelope"></i> <span id="userEmail"></span>
                </p>
                <p><i class="fas fa-phone"></i> <span id="userPhone"></span></p>
                <span class="profile-badge" id="userRole">Étudiant</span>
              </div>
            </div>
          </div>

          <!-- Statistics -->
          <div class="profile-card">
            <h2><i class="fas fa-chart-bar"></i> Mes Statistiques</h2>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="totalPreinscriptions">0</div>
                <div class="stat-label">Préinscriptions</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="enCoursCount">0</div>
                <div class="stat-label">En Cours</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="valideCount">0</div>
                <div class="stat-label">Validées</div>
              </div>
            </div>
          </div>

          <!-- Main Grid -->
          <div class="profile-grid">
            <!-- Update Profile -->
            <div class="profile-card">
              <h2>
                <i class="fas fa-user-edit"></i> Modifier mes informations
              </h2>
              <form id="updateProfileForm">
                <div class="form-group">
                  <label>Nom</label>
                  <input type="text" id="nom" name="nom" required />
                </div>
                <div class="form-group">
                  <label>Prénom</label>
                  <input type="text" id="prenom" name="prenom" required />
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="email" disabled />
                </div>
                <div class="form-group">
                  <label>Téléphone</label>
                  <input type="tel" id="telephone" name="telephone" />
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Enregistrer
                </button>
              </form>
            </div>

            <!-- Change Password -->
            <div class="profile-card">
              <h2><i class="fas fa-lock"></i> Changer mon mot de passe</h2>
              <form id="changePasswordForm">
                <div class="form-group">
                  <label>Mot de passe actuel</label>
                  <input
                    type="password"
                    id="currentPassword"
                    name="current_password"
                    required
                  />
                </div>
                <div class="form-group">
                  <label>Nouveau mot de passe</label>
                  <input
                    type="password"
                    id="newPassword"
                    name="new_password"
                    required
                  />
                </div>
                <div class="form-group">
                  <label>Confirmer le mot de passe</label>
                  <input
                    type="password"
                    id="confirmPassword"
                    name="confirm_password"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-key"></i> Modifier
                </button>
              </form>
            </div>
          </div>

          <!-- Preinscriptions List -->
          <div class="profile-card">
            <h2><i class="fas fa-list"></i> Mes Préinscriptions</h2>
            <div class="preinscriptions-list" id="preinscriptionsList">
              <p style="text-align: center; color: #777">Chargement...</p>
            </div>
          </div>
        </div>

        <script>
          let userProfile = null;

          // Charger le profil au chargement de la page
          window.addEventListener("DOMContentLoaded", () => {
            loadProfile();
          });

          // Charger le profil
          async function loadProfile() {
            try {
              const response = await fetch("/api/auth/profile");
              const data = await response.json();

              if (data.success) {
                userProfile = data.user;
                displayProfile(userProfile);
                loadPreinscriptions();
              } else {
                showAlert("Erreur lors du chargement du profil", "error");
                window.location.href = "/login";
              }
            } catch (error) {
              console.error("Erreur:", error);
              showAlert("Erreur de connexion", "error");
            }
          }

          // Afficher le profil
          function displayProfile(user) {
            // Avatar avec initiales
            const initials = (
              user.nom.charAt(0) + user.prenom.charAt(0)
            ).toUpperCase();
            document.getElementById("avatar").textContent = initials;

            // Informations
            document.getElementById(
              "userName"
            ).textContent = `${user.prenom} ${user.nom}`;
            document.getElementById("userEmail").textContent = user.email;
            document.getElementById("userPhone").textContent =
              user.telephone || "Non renseigné";
            document.getElementById("userRole").textContent = getRoleLabel(
              user.role
            );

            // Formulaire
            document.getElementById("nom").value = user.nom;
            document.getElementById("prenom").value = user.prenom;
            document.getElementById("email").value = user.email;
            document.getElementById("telephone").value = user.telephone || "";

            // Statistiques
            document.getElementById("totalPreinscriptions").textContent =
              user.stats.total_preinscriptions;
            document.getElementById("enCoursCount").textContent =
              user.stats.en_cours || 0;
            document.getElementById("valideCount").textContent =
              user.stats.valide || 0;
          }

          // Charger les préinscriptions
          async function loadPreinscriptions() {
            try {
              const response = await fetch(
                `/api/preinscriptions?user_id=${userProfile.id}`
              );
              const data = await response.json();

              if (data.success) {
                displayPreinscriptions(data.preinscriptions);
              }
            } catch (error) {
              console.error("Erreur:", error);
            }
          }

          // Afficher les préinscriptions
          function displayPreinscriptions(preinscriptions) {
            const container = document.getElementById("preinscriptionsList");

            if (preinscriptions.length === 0) {
              container.innerHTML =
                '<p style="text-align: center; color: #777;">Aucune préinscription trouvée</p>';
              return;
            }

            container.innerHTML = preinscriptions
              .map(
                (p) => `
                <div class="preinscription-item">
                    <h3>${p.filiere_nom} - ${p.niveau}</h3>
                    <p><strong>Établissement:</strong> ${
                      p.etablissement_nom
                    }</p>
                    <p><strong>Date:</strong> ${formatDate(
                      p.date_soumission
                    )}</p>
                    <p><span class="status-badge status-${
                      p.statut
                    }">${getStatusLabel(p.statut)}</span></p>
                </div>
            `
              )
              .join("");
          }

          // Mettre à jour le profil
          document
            .getElementById("updateProfileForm")
            .addEventListener("submit", async (e) => {
              e.preventDefault();

              const formData = {
                nom: document.getElementById("nom").value,
                prenom: document.getElementById("prenom").value,
                telephone: document.getElementById("telephone").value,
              };

              try {
                const response = await fetch("/api/auth/profile", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(formData),
                });

                const data = await response.json();

                if (data.success) {
                  showAlert("Profil mis à jour avec succès !", "success");
                  await loadProfile();
                } else {
                  showAlert(
                    data.error || "Erreur lors de la mise à jour",
                    "error"
                  );
                }
              } catch (error) {
                console.error("Erreur:", error);
                showAlert("Erreur de connexion", "error");
              }
            });

          // Changer le mot de passe
          document
            .getElementById("changePasswordForm")
            .addEventListener("submit", async (e) => {
              e.preventDefault();

              const currentPassword =
                document.getElementById("currentPassword").value;
              const newPassword = document.getElementById("newPassword").value;
              const confirmPassword =
                document.getElementById("confirmPassword").value;

              if (newPassword !== confirmPassword) {
                showAlert("Les mots de passe ne correspondent pas", "error");
                return;
              }

              try {
                const response = await fetch("/api/auth/change-password", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword,
                    confirm_password: confirmPassword,
                  }),
                });

                const data = await response.json();

                if (data.success) {
                  showAlert("Mot de passe modifié avec succès !", "success");
                  document.getElementById("changePasswordForm").reset();
                } else {
                  showAlert(
                    data.error || "Erreur lors du changement de mot de passe",
                    "error"
                  );
                }
              } catch (error) {
                console.error("Erreur:", error);
                showAlert("Erreur de connexion", "error");
              }
            });

          // Déconnexion
          async function logout() {
            try {
              const response = await fetch("/api/auth/logout", {
                method: "POST",
              });
              const data = await response.json();

              if (data.success) {
                window.location.href = "/login";
              }
            } catch (error) {
              console.error("Erreur:", error);
              window.location.href = "/login";
            }
          }

          // Afficher une alerte
          function showAlert(message, type) {
            const alert = document.getElementById("alert");
            // Ensure we display a trimmed string (avoid accidental newlines)
            const text =
              message === null || message === undefined
                ? ""
                : String(message).trim();
            alert.textContent = text;
            alert.className = `alert alert-${type}`;
            alert.style.display = "block";

            setTimeout(() => {
              alert.style.display = "none";
            }, 5000);
          }

          // Obtenir le label du rôle
          function getRoleLabel(role) {
            const labels = {
              admin: "Administrateur",
              etudiant: "Étudiant",
              visiteur: "Visiteur",
            };
            return labels[role] || role;
          }

          // Obtenir le label du statut
          function getStatusLabel(statut) {
            const labels = {
              nouveau: "Nouveau",
              en_cours: "En Cours",
              validé: "Validé",
              rejeté: "Rejeté",
            };
            return labels[statut] || statut;
          }

          // Formater la date
          function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString("fr-FR", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });
          }
        </script>
      </main>
    </div>
  </body>
</html>
